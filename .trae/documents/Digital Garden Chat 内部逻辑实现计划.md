# Digital Garden Chat 内部逻辑实现计划

## 总体实现策略
将功能分为5个主要模块，每个模块实现完成后提交一次Git记录。

---

## 模块1：聊天视图基础功能实现

### 1.1 增强后端控制器
- 扩展 `ChatController` 类，添加以下功能：
  - `send_message()`: 发送消息到Dify（暂时返回"1"）
  - `stop_generation()`: 停止AI生成
  - 信号：`messageReceived`, `generationStarted`, `generationStopped`, `loadingStateChanged`

### 1.2 优化聊天界面UI
- 修改消息布局：
  - 用户消息右对齐，系统消息左对齐
  - 消息之间添加分隔线
- 添加加载动画组件（旋转图标）
- 实现发送按钮状态切换：
  - 发送中：显示"停止"图标，背景白色
  - 空闲：显示"发送"图标，背景灰色

### 1.3 实现对话标题管理
- 第一条用户消息自动成为对话标题
- 标题显示在侧边栏历史列表中

---

## 模块2：对话历史管理

### 2.1 对话数据结构
```python
{
    "id": "uuid",
    "title": "对话标题",
    "messages": [
        {"role": "user", "content": "...", "timestamp": "..."},
        {"role": "assistant", "content": "...", "timestamp": "..."}
    ],
    "created_at": "...",
    "updated_at": "..."
}
```

### 2.2 实现功能
- 创建新对话（点击"新建对话"按钮）
- 保存对话到历史（首次发送消息后）
- 加载历史对话（点击历史列表项）
- 对话排序（最近更新的置顶）
- 高亮显示当前对话

---

## 模块3：设置持久化

### 3.1 配置文件格式选择：JSON
**选择理由**：
- Python内置支持，无需额外依赖
- 广泛使用，生态成熟
- 易于读写和调试
- 适合存储简单的键值对配置

### 3.2 配置文件结构
```json
{
    "dify": {
        "dataset_api": "...",
        "dataset_id": "...",
        "app_url": "...",
        "app_api": "..."
    },
    "general": {
        "language": "简体中文"
    }
}
```

### 3.3 实现功能
- 创建 `ConfigManager` 类
- 启动时加载配置
- 设置修改时自动保存
- 提供配置验证

---

## 模块4：对话持久化方案

### 4.1 存储方案选择：JSON文件
**对比分析**：

| 方案 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| **JSON文件** | 简单易实现、易于备份迁移、可读性好 | 大数据量查询慢、无并发控制 | 小规模数据、个人应用 ✅ |
| SQLite | 查询快、支持复杂查询、内置事务 | 需要数据库知识、备份复杂 | 大规模数据、多用户 |
| 文本文件 | 最简单 | 功能有限、难以查询 | 日志记录 |

**选择JSON文件的理由**：
- 本项目为单用户桌面应用，数据量不会很大
- 实现简单，便于调试和维护
- 易于备份和迁移
- 未来可平滑迁移到SQLite

### 4.2 数据结构设计
```json
{
    "conversations": [
        {
            "id": "conv-001",
            "title": "如何使用Dify",
            "messages": [...],
            "created_at": "2024-01-01T00:00:00",
            "updated_at": "2024-01-01T00:00:00"
        }
    ],
    "current_conversation_id": "conv-001"
}
```

### 4.3 实现功能
- 创建 `ConversationManager` 类
- 对话CRUD操作
- 自动保存机制
- 数据验证

---

## 模块5：消息显示优化方案

### 5.1 渲染方案选择：Text组件 + 基础格式化

**对比分析**：

| 方案 | 优点 | 缺点 | 实现难度 |
|------|------|------|----------|
| **Text组件 + 格式化** | 轻量级、无需依赖、性能好 | 功能有限 | 低 ✅ |
| WebEngine | 功能强大、支持完整Markdown | 体积大、性能开销高 | 高 |
| 第三方库 | 功能丰富 | 增加依赖 | 中 |

**选择Text组件的理由**：
- QML Text组件支持基础富文本（HTML子集）
- 足够满足当前需求（加粗、代码块、链接）
- 无需额外依赖，保持轻量

### 5.2 实现功能
- 创建 `MarkdownFormatter` 类
- 支持基础Markdown语法：
  - **粗体**
  - `代码`
  - ```代码块```
  - [链接](url)
- 优化代码块显示（等宽字体、背景色）

---

## 实现顺序与Git提交

1. **提交1**: 实现聊天视图基础功能
2. **提交2**: 实现对话历史管理
3. **提交3**: 实现设置持久化
4. **提交4**: 实现对话持久化
5. **提交5**: 实现消息显示优化

---

## 新增文件清单

- `config_manager.py` - 配置管理器
- `conversation_manager.py` - 对话管理器
- `markdown_formatter.py` - Markdown格式化器
- `data/config.json` - 配置文件（自动生成）
- `data/conversations.json` - 对话数据（自动生成）
- `data/` - 数据目录

---

## 技术要点

- 使用Python `uuid`模块生成对话ID
- 使用 `datetime`模块处理时间戳
- 使用 `json`模块处理数据持久化
- 使用 `threading`或`asyncio`处理异步消息
- 使用QML `Timer`实现加载动画

---

## 注意事项

- 每个模块完成后立即提交Git
- 提交信息使用中文描述
- 保持代码简洁，添加必要注释
- 确保向后兼容性