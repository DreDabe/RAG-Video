# 更新知识库功能集成计划

## 概述
将 `doc/test-1.py` 的视频处理功能集成到Qt项目中，实现从B站下载视频、语音识别、AI分析并上传到Dify知识库的完整流程。

## 实施步骤

### 1. 创建知识库更新管理器 (`knowledge_updater.py`)
- 封装test-1.py的核心功能为Python类
- 实现以下方法：
  - `start_update()`：启动更新流程
  - `stop_update()`：停止更新流程
  - `get_log()`：获取日志内容
  - `is_running()`：检查是否正在运行
- 支持实时日志输出到QML界面
- 使用线程处理长时间任务，避免阻塞UI

### 2. 扩展配置管理器 (`config_manager.py`)
在现有配置结构中添加知识库更新相关配置：
```python
'knowledge_update': {
    'platform': 'Bilibili',
    'type': '收藏夹',
    'url': '',
    'cookie': '',
    'whisper_path': 'utils/whisper',
    'ollama_url': 'http://localhost:11434/api/generate',
    'ollama_model': 'deepseek-r1:8b'
}
```
添加相应的getter/setter方法

### 3. 更新QML界面 (`main.qml`)
#### 3.1 绑定配置数据
- 将更新知识库界面的输入框绑定到configManager
- 在Component.onCompleted时加载配置
- 在文本变化时自动保存配置

#### 3.2 实现日志输出
- 将运行日志TextArea绑定到knowledgeUpdater
- 使用信号机制实时更新日志内容
- 自动滚动到最新日志

#### 3.3 实现按钮功能
- "开始更新知识库"按钮调用knowledgeUpdater.start_update()
- 添加"停止更新"按钮（运行时显示）
- 显示运行状态（运行中/空闲）

### 4. 更新主程序 (`main.py`)
- 导入并创建KnowledgeUpdater实例
- 注册到QML上下文：`engine.rootContext().setContextProperty("knowledgeUpdater", knowledge_updater)`

### 5. 更新依赖 (`requirements.txt`)
添加test-1.py所需的依赖：
- yt-dlp
- faster-whisper
- requests
- (ffmpeg需要系统安装，不通过pip)

### 6. 处理路径问题
- Whisper模型路径：`utils/whisper`（相对路径）
- 临时文件目录：`data/bili_temp`
- 下载历史：`data/download_history.txt`
- Cookie文件：`data/cookies.txt`

### 7. 实现异步日志输出
- 使用PySide6的Signal机制
- 在后台线程中处理视频
- 通过信号将日志发送到主线程更新UI

## 关键技术点

1. **线程安全**：使用QThread或threading + Signal确保UI更新安全
2. **配置持久化**：所有配置自动保存到data/config.json
3. **日志实时显示**：使用信号槽机制实现实时日志更新
4. **错误处理**：捕获并显示所有异常到日志窗口
5. **资源清理**：任务结束后清理临时文件

## 文件清单

### 新建文件
- `knowledge_updater.py`：知识库更新管理器

### 修改文件
- `main.py`：注册knowledgeUpdater
- `main.qml`：绑定配置、实现日志输出和按钮功能
- `config_manager.py`：添加知识库更新配置
- `requirements.txt`：添加依赖

### 新建目录
- `data/bili_temp`：临时文件目录（自动创建）
- `data/cookies.txt`：Cookie文件（用户输入）