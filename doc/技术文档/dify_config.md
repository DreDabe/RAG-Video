# Dify 代码执行块配置指南

## 1. 代码执行块基本配置

### 1.1 代码内容
将 `testv2.py` 中的完整代码复制到 Dify 代码执行块中。

### 1.2 依赖管理
在代码执行块的 **依赖** 部分添加：
```
yt-dlp
```

### 1.3 输入配置
设置输入参数，用于接收视频URL和保存路径：

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| url | 字符串 | - | 要下载的B站视频或收藏夹URL |
| save_path | 字符串 | my_videos | 视频保存路径 |

### 1.4 输出配置
设置输出格式为 JSON，用于接收下载结果：

| 输出字段 | 类型 | 说明 |
|----------|------|------|
| success | 布尔值 | 下载是否成功 |
| message | 字符串 | 执行结果消息 |
| url | 字符串 | 下载的视频URL |
| save_path | 字符串 | 实际保存路径 |

## 2. 高级配置

### 2.1 环境变量
如果需要，可以设置以下环境变量：

| 环境变量名 | 说明 |
|------------|------|
| COOKIE_FILE_PATH | 自定义cookies.txt文件路径 |

### 2.2 超时设置
由于视频下载可能需要较长时间，建议将代码执行块的超时时间设置为：
- **超时时间**：3600秒（1小时）
- **内存限制**：512MB 或更高

## 3. 使用方法

### 3.1 直接调用
在 Dify 应用中，通过以下方式调用代码执行块：

```json
{
  "url": "https://www.bilibili.com/medialist/play/ml387412427",
  "save_path": "B站收藏夹视频"
}
```

### 3.2 从对话中获取URL
结合 Dify 的对话功能，可以从用户输入中提取URL：

```
用户：帮我下载这个视频 https://www.bilibili.com/video/BV1xx411c7m9
助手：好的，我来帮您下载这个视频。
```

在工作流中，使用 **变量提取** 节点从用户输入中提取URL，然后传递给代码执行块。

## 4. 注意事项

### 4.1 Cookies.txt 文件
- 确保 `cookies.txt` 文件与代码执行块在同一环境中
- 可以通过浏览器插件（如 Get cookies.txt LOCALLY）导出B站 cookies
- 没有 cookies 可能无法访问部分受限内容（如收藏夹）

### 4.2 下载历史记录
- 代码会自动创建 `download_history.txt` 文件，记录已下载的视频ID
- 再次运行时会跳过已下载的视频

### 4.3 存储空间
- 确保执行环境有足够的存储空间
- 可以通过 `save_path` 参数指定不同的保存目录

### 4.4 网络连接
- 确保执行环境可以访问B站网站
- 部分地区可能需要设置代理

## 5. 调试与日志

### 5.1 查看日志
在 Dify 应用的 **运行日志** 中可以查看代码执行的详细日志，包括：
- 下载进度
- 错误信息
- 执行结果

### 5.2 常见错误排查

| 错误类型 | 可能原因 | 解决方案 |
|----------|----------|----------|
| 403 Forbidden | Cookies 无效或已过期 | 重新导出 cookies.txt 文件 |
| 网络超时 | 网络连接不稳定 | 检查网络连接或增加超时时间 |
| 存储空间不足 | 磁盘空间不够 | 清理磁盘或更换保存路径 |
| 依赖安装失败 | 网络问题或版本冲突 | 尝试指定具体版本：`yt-dlp==2023.12.30` |

## 6. 示例工作流

1. **用户输入**：用户发送包含B站URL的消息
2. **变量提取**：从消息中提取URL
3. **代码执行块**：调用 testv2.py 代码，传递URL参数
4. **结果处理**：根据执行结果生成回复
5. **返回给用户**：将下载结果告知用户

## 7. 安全建议

- 不要在代码中硬编码敏感信息
- 定期更新 cookies.txt 文件
- 限制代码执行块的访问权限
- 监控代码执行的资源使用情况
