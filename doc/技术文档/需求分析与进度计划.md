
# RAG视频知识库检索 - 需求分析与进度计划

## 文档说明

本文档基于项目描述、可行性分析报告、项目描述报告和相关项目对照文档，进行需求分析并制定详细的进度计划。

**文档生成时间**：2025-12-29

**文档目的**：
1. 明确项目需求和目标
2. 制定MVP进度计划（快速交付版本）
3. 制定精细化开发进度计划（完整功能版本）

---

## 一、需求分析

### 1.1 项目背景

**问题陈述**：
在日常使用视频平台的过程中，用户会遇到大量有价值的内容，但由于时间、注意力等原因无法当场掌握，只能收藏到收藏夹中。随着收藏内容增多，导致：
- 信息过载，难以管理
- 检索困难，无法快速定位
- 内容遗忘，优质内容"吃灰"
- 效率低下，需要重新观看

**项目目标**：
构建基于RAG技术的视频知识库系统，实现：
1. 自动化内容提取
2. 结构化知识库
3. 智能检索
4. 精准返回

### 1.2 核心需求

#### 1.2.1 功能性需求

| 需求编号 | 需求名称 | 需求描述 | 优先级 |
|---------|---------|---------|--------|
| FR-001 | 视频获取 | 从主流视频平台（B站、YouTube等）自动获取视频内容 | 高 |
| FR-002 | 视频元数据提取 | 自动获取视频标题、时长、作者、简介等元数据 | 高 |
| FR-003 | 字幕提取 | 提取视频字幕（如有）或自动生成字幕 | 高 |
| FR-004 | 关键帧提取 | 从视频中提取关键帧图片 | 中 |
| FR-005 | OCR识别 | 对关键帧进行文字识别 | 中 |
| FR-006 | 语音识别 | 将视频语音转换为文字 | 中 |
| FR-007 | 内容解析 | 利用大模型分析视频内容，生成结构化文档 | 高 |
| FR-008 | 知识库管理 | 将生成的文档上传到知识库并建立索引 | 高 |
| FR-009 | 智能检索 | 用户通过自然语言查询，系统返回相关内容 | 高 |
| FR-010 | 批量处理 | 支持批量处理多个视频 | 中 |

#### 1.2.2 非功能性需求

| 需求编号 | 需求名称 | 需求描述 | 优先级 |
|---------|---------|---------|--------|
| NFR-001 | 性能 | 视频处理时间不超过视频时长的2倍 | 中 |
| NFR-002 | 可用性 | 系统可用性达到99% | 高 |
| NFR-003 | 可扩展性 | 支持添加新的视频平台 | 中 |
| NFR-004 | 易用性 | 用户界面友好，操作简单 | 高 |
| NFR-005 | 准确性 | 检索结果准确率达到85%以上 | 高 |

### 1.3 用户角色

| 用户角色 | 角色描述 | 主要需求 |
|---------|---------|---------|
| 普通用户 | 使用视频平台收藏视频的个人用户 | 快速检索收藏内容，无需重复观看 |
| 管理员 | 系统维护者 | 管理知识库，监控系统运行状态 |

### 1.4 系统边界

**系统包含**：
- 视频获取模块
- 视频处理模块
- 内容解析模块
- 知识库管理模块
- 智能检索模块

**系统不包含**：
- 视频平台本身的访问和管理
- 用户账户管理系统（使用Dify内置）
- 支付系统

---

## 二、技术架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        用户交互层                             │
│                    Dify 聊天界面                             │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌───────────────────────────────────────────────────────────-─┐
│                    Dify 工作流引擎                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  视频获取     │→ │  视频处理     │→ │  内容解析      │       │
│  │  工作流       │  │  工作流      │   │  工作流       │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────-──┐
│                    知识库存储层                               │
│              Dify 向量数据库 + 文件存储                        │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 技术栈

| 模块 | 推荐技术 | 说明 |
|-----|---------|------|
| 工作流平台 | Dify | 开源、支持RAG、可视化配置 |
| 视频下载 | yt-dlp | 支持多平台、功能强大 |
| 视频处理 | FFmpeg | 业界标准、功能全面 |
| OCR识别 | PaddleOCR | 中文识别效果好 |
| 语音识别 | Whisper | 开源、准确度高 |
| 多模态模型 | GPT-4V / Qwen-VL | 理解视频内容 |
| 向量数据库 | Dify内置 | 无需额外部署 |
| 编程语言 | Python | 生态丰富、易维护 |

---

## 三、MVP进度计划（简化版）

### 3.1 MVP目标

**核心目标**：在短时间内（2-3周）交付一个可运行的系统，跑通整个流程。

**简化原则**：
1. 优先使用Dify内置节点
2. 尽量使用开源项目，避免代码编写
3. 简化每个模块的具体实现
4. 只支持核心功能，暂不优化性能

### 3.2 MVP功能范围

| 功能模块 | 完整版功能 | MVP简化版 | 简化原因 |
|---------|-----------|-----------|---------|
| 视频获取 | 支持多平台、批量下载 | 只支持B站，单个下载 | 快速验证核心流程 |
| 视频处理 | 抽帧、OCR、语音识别 | 只提取字幕 | 字幕提取最简单 |
| 内容解析 | 多模态理解、结构化文档 | 只处理字幕文本，简单摘要 | 避免复杂的多模态处理 |
| 知识库管理 | 自动上传、智能分块 | 手动上传文档 | 使用Dify内置功能 |
| 智能检索 | 混合检索、重排序 | 基础向量检索 | 使用Dify内置RAG |

### 3.3 MVP技术方案

#### 3.3.1 视频获取模块

**实现方式**：使用Dify的"代码执行"节点调用yt-dlp命令

**简化方案**：
- 不开发Python代码，直接使用yt-dlp命令行工具
- 只支持B站平台
- 只下载视频和字幕，不下载视频文件（节省空间）

**Dify节点配置**：
```
节点类型：代码执行（Code Execution）
执行内容：
  - 安装yt-dlp：pip install yt-dlp
  - 下载视频：yt-dlp --write-sub --skip-download [URL]
  - 提取元数据：yt-dlp --dump-json [URL]
输入：视频URL
输出：字幕文件路径、视频元数据（JSON）
```

**优点**：
- 无需编写代码
- 快速集成
- 利用Dify内置环境

#### 3.3.2 视频处理模块

**实现方式**：跳过，直接使用字幕文件

**简化方案**：
- 不进行关键帧提取
- 不进行OCR识别
- 不进行语音识别
- 直接使用yt-dlp下载的字幕文件

**原因**：
- 字幕提取最简单
- 字幕包含大部分关键信息
- 避免复杂的视频处理

**优点**：
- 极大简化流程
- 减少处理时间
- 降低技术复杂度

#### 3.3.3 内容解析模块



**实现方式**：使用Dify的"LLM"节点

**简化方案**：
- 只处理字幕文本
- 使用轻量级模型（Qwen-Turbo）
- 生成简单的摘要

**Dify节点配置**：
```
节点类型：LLM Chat
模型：Qwen-Turbo（或GPT-3.5-Turbo）
输入：字幕文本、视频元数据
Prompt模板：
  "请根据以下视频字幕和元数据，生成一个视频摘要：
  标题：{{title}}
  //标签：{{平台}-{收藏夹名字}}

  请生成：
  1. 视频摘要（200-300字）
  2. 关键内容（3-5个要点）
  3. 详细笔记（按时间戳整理）"
输出：结构化文档（Markdown格式）
```

**优点**：
- 使用Dify内置节点，无需代码
- 轻量级模型，响应快
- 简化Prompt，易于实现

#### 3.3.4 知识库管理模块

**实现方式**：使用Dify内置知识库功能

**简化方案**：
- 手动上传生成的文档到知识库
- 使用默认分块策略
- 使用默认嵌入模型

**操作步骤**：
1. 在Dify中创建知识库
2. 手动上传生成的Markdown文档
3. 系统自动向量化并建立索引

**优点**：
- 使用Dify内置功能，无需开发
- 快速建立知识库
- 自动处理分块和向量化

#### 3.3.5 智能检索模块

**实现方式**：使用Dify内置RAG功能

**简化方案**：
- 创建RAG应用
- 配置知识库
- 使用默认检索参数

**Dify应用配置**：
```
应用类型：知识库问答（RAG）
知识库：选择已创建的知识库
模型：Qwen-Turbo
检索参数：
  - Top K：3
  - Score Threshold：0.5
  - 检索模式：向量检索
```

**优点**：
- 使用Dify内置RAG功能
- 可视化配置，无需代码
- 快速验证检索效果

### 3.4 MVP实施计划

#### 第1周：环境搭建和基础配置

**目标**：完成Dify部署和基础配置

**任务清单**：
- [ ] Day 1-2：部署Dify平台
  - 使用Docker部署Dify
  - 配置数据库和向量存储
  - 验证Dify正常运行

- [ ] Day 3：安装视频处理工具
  - 在Dify环境中安装yt-dlp
  - 测试yt-dlp下载B站视频
  - 测试字幕提取功能

- [ ] Day 4-5：创建知识库
  - 在Dify中创建知识库
  - 配置分块策略（默认）
  - 配置嵌入模型（默认）

**交付物**：
- 可运行的Dify平台
- 可用的知识库

#### 第2周：工作流开发

**目标**：完成视频入库工作流

**任务清单**：
- [ ] Day 1-2：创建视频获取工作流
  - 创建新的工作流
  - 添加"开始"节点（输入视频URL）
  - 添加"代码执行"节点（调用yt-dlp）
  - 测试视频下载和字幕提取

- [ ] Day 3-4：创建内容解析工作流
  - 添加"LLM"节点（Qwen-Turbo）
  - 设计Prompt模板
  - 测试内容解析功能

- [ ] Day 5：整合工作流
  - 将视频获取和内容解析串联
  - 生成结构化文档
  - 手动上传到知识库

**交付物**：
- 完整的视频入库工作流
- 可生成结构化文档

#### 第3周：RAG应用和测试

**目标**：完成RAG应用和端到端测试

**任务清单**：
- [ ] Day 1-2：创建RAG应用
  - 创建知识库问答应用
  - 配置知识库
  - 配置检索参数

- [ ] Day 3-4：端到端测试
  - 测试完整流程：视频URL → 入库 → 检索
  - 准备测试视频（3-5个）
  - 执行测试并记录结果

- [ ] Day 5：优化和文档
  - 根据测试结果优化Prompt
  - 编写用户使用文档
  - 准备演示

**交付物**：
- 可用的RAG应用
- 完整的测试报告
- 用户使用文档

### 3.5 MVP验收标准

**功能验收**：
- [ ] 能够从B站下载视频字幕
- [ ] 能够生成视频摘要和关键内容
- [ ] 能够将文档上传到知识库
- [ ] 能够通过自然语言检索视频内容
- [ ] 检索结果准确且相关

**性能验收**：
- [ ] 单个视频处理时间 < 5分钟
- [ ] 检索响应时间 < 3秒
- [ ] 系统稳定运行，无崩溃

**文档验收**：
- [ ] 用户使用文档完整
- [ ] 测试报告详细
- [ ] 演示视频准备就绪

---

## 四、精细化开发进度计划（完整版）

### 4.1 开发目标

**核心目标**：在MVP基础上，对每个模块进行精细化开发和优化，实现完整功能。

**优化方向**：
1. 增强视频处理能力（抽帧、OCR、语音识别）
2. 优化内容解析质量（多模态理解）
3. 提升知识库管理效率（自动上传、智能分块）
4. 改进检索效果（混合检索、重排序）

### 4.2 功能增强计划

#### 4.2.1 视频获取模块增强

**当前状态（MVP）**：
- 只支持B站
- 只下载字幕
- 单个下载

**增强目标**：
- 支持多平台（YouTube、抖音等）
- 下载视频文件
- 支持批量下载
- 自动获取视频元数据

**实施方案**：
1. **阶段一**：扩展平台支持
   - 集成yt-dlp的多平台支持
   - 测试YouTube、抖音等平台
   - 处理不同平台的字幕格式

2. **阶段二**：视频文件下载
   - 下载视频文件（用于后续抽帧）
   - 配置视频质量和格式
   - 实现视频文件管理

3. **阶段三**：批量处理
   - 支持批量URL输入
   - 实现队列管理
   - 添加进度显示

**技术实现**：
```python
# 使用Python封装yt-dlp
import yt_dlp

def download_video(url):
    ydl_opts = {
        'format': 'best',
        'writesubtitles': True,
        'writeautomaticsub': True,
        'subtitleslangs': ['zh', 'en'],
        'outtmpl': '%(title)s.%(ext)s',
    }
    with yt_dlp.YoutubeDL(ydl_opts) as ydl:
        info = ydl.extract_info(url, download=True)
        return info
```

**预计时间**：2-3周

#### 4.2.2 视频处理模块增强

**当前状态（MVP）**：
- 不进行视频处理
- 只使用字幕

**增强目标**：
- 关键帧提取
- OCR文字识别
- 语音识别（Whisper）
- 场景变化检测

**实施方案**：

1. **阶段一**：关键帧提取
   - 使用FFmpeg提取关键帧
   - 实现场景变化检测
   - 优化抽帧策略

   **技术实现**：
   ```python
   import ffmpeg

   def extract_keyframes(video_path, output_dir, interval=30):
       # 每30秒提取一帧
       (
           ffmpeg
           .input(video_path)
           .output(f'{output_dir}/frame_%04d.jpg', vf=f'select=not(mod(n\,{interval}))', vsync='vfr')
           .run()
       )
   ```

2. **阶段二**：OCR识别
   - 集成PaddleOCR
   - 批量处理关键帧
   - 过滤和去重

   **技术实现**：
   ```python
   from paddleocr import PaddleOCR

   ocr = PaddleOCR(use_angle_cls=True, lang='ch')

   def extract_text_from_frames(frames):
       all_text = []
       for frame in frames:
           result = ocr.ocr(frame, cls=True)
           for line in result:
               all_text.append(line[1][0])
       return all_text
   ```

3. **阶段三**：语音识别
   - 集成Whisper
   - 提取音频轨道
   - 生成时间戳字幕

   **技术实现**：
   ```python
   import whisper

   model = whisper.load_model("base")

   def transcribe_audio(audio_path):
       result = model.transcribe(audio_path, language='zh')
       return result['segments']
   ```

**预计时间**：3-4周

#### 4.2.3 内容解析模块增强

**当前状态（MVP）**：
- 只处理字幕文本
- 使用轻量级模型
- 简单摘要

**增强目标**：
- 多模态理解（图像+文本）
- 使用更强大的模型（GPT-4V）
- 生成更详细的结构化文档
- 支持批量处理

**实施方案**：

1. **阶段一**：多模态理解
   - 集成GPT-4V API
   - 处理关键帧图片
   - 结合字幕、OCR、语音文本

   **技术实现**：
   ```python
   from openai import OpenAI

   client = OpenAI()

   def analyze_video_content(frames, subtitle, ocr_text, metadata):
       # 选择代表性帧（最多5帧）
       representative_frames = select_representative_frames(frames, max_count=5)

       # 构建多模态输入
       content = []
       for frame in representative_frames:
           content.append({
               "type": "image_url",
               "image_url": {"url": frame}
           })
       content.append({
           "type": "text",
           "text": f"字幕：{subtitle}\nOCR文字：{ocr_text}\n元数据：{metadata}"
       })

       response = client.chat.completions.create(
           model="gpt-4-vision-preview",
           messages=[{
               "role": "user",
               "content": content
           }]
       )
       return response.choices[0].message.content
   ```

2. **阶段二**：结构化文档生成
   - 设计详细的文档模板
   - 优化Prompt工程
   - 支持多种输出格式

   **文档结构**：
   ```markdown
   ## 视频信息
   - 标题、时长、作者、发布时间、链接

   ## 视频摘要
   - 200-300字概述

   ## 关键内容
   - 要点1（详细说明）
   - 要点2（详细说明）
   - ...

   ## 详细笔记
   - [00:00] 对应内容
   - [00:30] 对应内容
   - ...

   ## 视觉内容
   - 关键帧描述
   - 画面中的文字
   ```

3. **阶段三**：批量处理优化
   - 实现异步处理
   - 添加队列管理
   - 优化API调用

**预计时间**：2-3周

#### 4.2.4 知识库管理模块增强

**当前状态（MVP）**：
- 手动上传文档
- 默认分块策略

**增强目标**：
- 自动上传文档
- 智能分块（按时间戳、按语义）
- 增量更新
- 文档版本管理

**实施方案**：

1. **阶段一**：自动上传
   - 使用Dify API自动上传
   - 实现文档自动入库
   - 添加进度反馈

   **技术实现**：
   ```python
   import requests

   def upload_to_knowledge_base(document, kb_id):
       url = f"{DIFY_API_URL}/datasets/{kb_id}/document/create"
       headers = {"Authorization": f"Bearer {API_KEY}"}
       data = {
           "name": document['title'],
           "text": document['content'],
           "indexing_technique": "high_quality",
       }
       response = requests.post(url, json=data, headers=headers)
       return response.json()
   ```

2. **阶段二**：智能分块
   - 按时间戳分块（适合视频内容）
   - 按语义段落分块
   - 混合分块策略

   **分块策略**：
   ```python
   def chunk_document(document):
       # 策略1：按时间戳分块
       if 'timestamp' in document:
           return chunk_by_timestamp(document)

       # 策略2：按语义段落分块
       else:
           return chunk_by_semantic(document)
   ```

3. **阶段三**：增量更新
   - 检测文档变化
   - 只更新变化的部分
   - 维护文档版本

**预计时间**：2周

#### 4.2.5 智能检索模块增强

**当前状态（MVP）**：
- 基础向量检索
- 默认检索参数

**增强目标**：
- 混合检索（关键词+向量）
- 重排序（Rerank）
- 引用来源标注
- 上下文窗口优化

**实施方案**：

1. **阶段一**：混合检索
   - 实现关键词检索
   - 结合向量检索
   - 结果融合

   **技术实现**：
   ```python
   def hybrid_search(query, knowledge_base):
       # 向量检索
       vector_results = vector_search(query, knowledge_base)

       # 关键词检索
       keyword_results = keyword_search(query, knowledge_base)

       # 结果融合（加权平均）
       final_results = merge_results(vector_results, keyword_results)
       return final_results
   ```

2. **阶段二**：重排序
   - 集成Rerank模型
   - 优化检索结果排序
   - 提升相关性

3. **阶段三**：来源标注
   - 标注引用来源
   - 显示时间戳
   - 提供原文链接

**预计时间**：2-3周

### 4.3 精细化开发时间表

| 阶段 | 任务 | 预计时间 | 依赖 |
|-----|------|---------|------|
| 阶段一 | 视频获取模块增强 | 2-3周 | MVP完成 |
| 阶段二 | 视频处理模块增强 | 3-4周 | 阶段一 |
| 阶段三 | 内容解析模块增强 | 2-3周 | 阶段二 |
| 阶段四 | 知识库管理模块增强 | 2周 | 阶段三 |
| 阶段五 | 智能检索模块增强 | 2-3周 | 阶段四 |
| 阶段六 | 系统集成和测试 | 2周 | 阶段五 |
| **总计** | **完整功能开发** | **13-17周** | - |

### 4.4 开发里程碑

| 里程碑 | 时间点 | 交付物 | 验收标准 |
|-------|-------|--------|---------|
| M1：MVP完成 | 第3周 | 可运行的MVP系统 | 核心流程跑通 |
| M2：视频处理增强 | 第7周 | 支持抽帧、OCR、语音识别 | 视频处理功能完整 |
| M3：内容解析增强 | 第10周 | 多模态理解、结构化文档 | 内容解析质量提升 |
| M4：知识库管理增强 | 第12周 | 自动上传、智能分块 | 知识库管理自动化 |
| M5：检索增强 | 第15周 | 混合检索、重排序 | 检索效果优化 |
| M6：系统完成 | 第17周 | 完整功能系统 | 所有功能验收通过 |

---

## 五、风险管理

### 5.1 技术风险

| 风险 | 影响 | 概率 | 应对措施 |
|-----|------|------|---------|
| 平台反爬导致视频获取失败 | 高 | 中 | 使用yt-dlp，定期更新，配置代理 |
| 长视频处理耗时过长 | 中 | 高 | 异步处理，智能采样，分布式部署 |
| 多模态模型API不稳定 | 中 | 中 | 实现重试机制，使用备用模型 |
| OCR识别准确度低 | 中 | 中 | 优化预处理，使用多个模型对比 |
| 知识库质量不佳 | 高 | 中 | 多阶段验证，人工审核，持续优化 |

### 5.2 进度风险

| 风险 | 影响 | 概率 | 应对措施 |
|-----|------|------|---------|
| 开发进度延迟 | 高 | 中 | 合理规划，预留缓冲时间 |
| 需求变更 | 中 | 中 | 灵活设计，模块化开发 |
| 技术难点突破困难 | 中 | 低 | 提前调研，寻求社区帮助 |

### 5.3 资源风险

| 风险 | 影响 | 概率 | 应对措施 |
|-----|------|------|---------|
| API成本过高 | 中 | 中 | 使用开源模型，优化调用次数 |
| 服务器资源不足 | 中 | 低 | 监控资源使用，及时扩容 |

---

## 六、质量保证

### 6.1 测试策略

**MVP阶段**：
- 功能测试：验证核心流程
- 集成测试：验证模块集成
- 用户测试：验证用户体验

**精细化开发阶段**：
- 单元测试：每个模块的单元测试
- 集成测试：模块间集成测试
- 性能测试：系统性能测试
- 压力测试：并发处理测试

### 6.2 验收标准

**功能验收**：
- [ ] 所有功能需求实现
- [ ] 功能测试通过率 > 95%
- [ ] 用户测试满意度 > 80%

**性能验收**：
- [ ] 视频处理时间 < 视频时长 × 2
- [ ] 检索响应时间 < 2秒
- [ ] 系统可用性 > 99%

**质量验收**：
- [ ] 检索准确率 > 85%
- [ ] 文档生成质量 > 80%
- [ ] 代码覆盖率 > 70%

---

## 七、总结

### 7.1 MVP总结

**核心优势**：
- 快速交付（2-3周）
- 技术复杂度低
- 风险可控
- 易于验证

**适用场景**：
- 学校项目实践
- 快速原型验证
- 概念证明（POC）

### 7.2 精细化开发总结

**核心优势**：
- 功能完整
- 性能优化
- 用户体验好
- 可扩展性强

**适用场景**：
- 正式产品发布
- 长期维护
- 商业应用

### 7.3 建议执行顺序

1. **第一阶段**：执行MVP计划（2-3周）
   - 快速交付可运行系统
   - 验证核心流程
   - 收集用户反馈

2. **第二阶段**：精细化开发（13-17周）
   - 根据反馈优化功能
   - 逐步增强各模块
   - 持续迭代优化

3. **第三阶段**：持续优化（长期）
   - 性能优化
   - 功能扩展
   - 用户体验提升

---

## 八、附录

### 8.1 参考文档

- 项目描述.md
- 可行性分析报告.md
- 项目描述报告.md
- 相关项目对照文档.md

### 8.2 相关资源

- Dify官方文档：https://docs.dify.ai/
- yt-dlp文档：https://github.com/yt-dlp/yt-dlp
- Whisper文档：https://github.com/openai/whisper
- PaddleOCR文档：https://github.com/PaddlePaddle/PaddleOCR

### 8.3 联系方式

如有问题，请联系项目团队。
