针对聊天历史记录的“重命名”和“删除”功能，参考 ChatGPT、Claude 以及 Ollama 的主流设计，**“悬浮触发 + 子菜单 + 行内重命名”** 是目前用户体验最好的方案。

以下是详细的设计方案描述及修改后的代码实现。

### 一、 设计方案描述

1.  **交互逻辑 (Interaction)**：
    *   **常规状态**：显示对话标题。
    *   **悬浮状态 (Hover)**：当鼠标悬停在某条记录上时，右侧淡入显示一个“更多”按钮（三个点图标 `img/更多.svg`）。
    *   **子菜单 (Menu)**：点击“更多”按钮，弹出具有毛玻璃效果或深色主题的菜单，包含：
        *   **重命名**：图标 `img/重命名.svg`。点击后，该条记录的文字变为一个输入框。
        *   **删除**：图标 `img/删除.svg`。点击后弹出二次确认提示，防止误删。
2.  **视觉设计 (Visuals)**：
    *   **重命名输入框**：采用无边框设计，仅在底部显示一个细弱的蓝色高亮边框，背景色略亮于侧边栏，直接在列表中编辑，无需弹出多余窗口。
    *   **配色**：菜单背景使用 `#1e1e20`，菜单项悬浮时变为 `#27272a`，与整体 Zinc 主题一致。
3.  **功能实现**：
    *   使用 `Menu` 组件实现弹出菜单。
    *   使用 `Loader` 或状态切换来实现“标题文本”与“重命名输入框”的无缝切换。

---

### 二、 参考代码实现

你需要修改 `main.qml` 中 `sidebar` 内部 `conversationList` 的 `delegate` 部分。

#### 1. 准备工作：在 `ApplicationWindow` 增加逻辑（可选，如果已有删除接口）
请确保 `conversationManager` 后端有 `rename_conversation(id, new_title)` 和 `delete_conversation(id)` 方法。

#### 2. 修改 `ListView` 的 `delegate`

```qml
                // --- 侧边栏对话列表修改后的 delegate ---
                delegate: ItemDelegate {
                    id: listDel
                    width: sidebar.width - 24
                    height: 40
                    hoverEnabled: true
                    
                    // 状态控制：是否正在重命名
                    property bool isEditing: false

                    onClicked: {
                        if (!isEditing) {
                            console.log("Clicked conversation:", model.id)
                            conversationManager.load_conversation(model.id)
                            loadMessages()
                        }
                    }

                    background: Rectangle {
                        color: (listDel.hovered || String(model.id) === String(conversationManager.current_conversation_id)) ? "#1d1d20" : "transparent"
                        radius: 8
                    }

                    contentItem: RowLayout {
                        anchors.fill: parent
                        anchors.leftMargin: 10
                        anchors.rightMargin: 8
                        spacing: 0

                        // 左侧图标/圆点
                        Item {
                            Layout.preferredWidth: 24
                            Layout.fillHeight: true
                            Text {
                                anchors.centerIn: parent
                                text: "•"
                                color: (listDel.hovered || String(model.id) === String(conversationManager.current_conversation_id)) ? "white" : "#3f3f46"
                                font.pixelSize: 20
                                visible: sidebarExpanded
                            }
                        }

                        // 中间：标题文本 或 重命名输入框
                        Item {
                            Layout.fillWidth: true
                            Layout.fillHeight: true
                            clip: true
                            visible: sidebarExpanded

                            // 状态 1：普通文本
                            Text {
                                anchors.fill: parent
                                anchors.verticalCenter: parent.verticalCenter
                                text: model.title
                                color: (listDel.hovered || String(model.id) === String(conversationManager.current_conversation_id)) ? "white" : "#a1a1aa"
                                font.pixelSize: 13
                                elide: Text.ElideRight
                                verticalAlignment: Text.AlignVCenter
                                visible: !listDel.isEditing
                            }

                            // 状态 2：重命名输入框
                            TextField {
                                id: editField
                                anchors.fill: parent
                                anchors.margins: 2
                                text: model.title
                                visible: listDel.isEditing
                                color: "white"
                                font.pixelSize: 13
                                selectionColor: "#3b82f6"
                                background: Rectangle {
                                    color: "#09090b"
                                    radius: 4
                                    border.color: "#3b82f6"
                                    border.width: 1
                                }
                                
                                Component.onCompleted: {
                                    if (visible) forceActiveFocus()
                                }

                                onAccepted: {
                                    if (text.trim() !== "") {
                                        conversationManager.rename_conversation(model.id, text.trim())
                                    }
                                    listDel.isEditing = false
                                }
                                
                                Keys.onEscapePressed: {
                                    text = model.title
                                    listDel.isEditing = false
                                }
                            }
                        }

                        // 右侧：更多操作按钮（仅在 Hover 时显示）
                        Button {
                            id: moreBtn
                            Layout.preferredWidth: 24
                            Layout.preferredHeight: 24
                            visible: sidebarExpanded && listDel.hovered && !listDel.isEditing
                            opacity: 0.7
                            
                            background: null
                            contentItem: Image {
                                source: "img/更多.svg" // 建议增加此图标
                                sourceSize: Qt.size(16, 16)
                                fillMode: Image.PreserveAspectFit
                            }

                            onClicked: actionMenu.open()

                            // 子菜单设计
                            Menu {
                                id: actionMenu
                                y: moreBtn.height
                                x: -width + moreBtn.width
                                
                                background: Rectangle {
                                    implicitWidth: 120
                                    color: "#1e1e20"
                                    border.color: "#2d2d30"
                                    radius: 8
                                }

                                MenuItem {
                                    text: "重命名"
                                    contentItem: RowLayout {
                                        spacing: 10
                                        Image { source: "img/重命名.svg"; sourceSize: Qt.size(14, 14) }
                                        Text { text: "重命名"; color: "white"; font.pixelSize: 12 }
                                    }
                                    onTriggered: {
                                        listDel.isEditing = true
                                        editField.forceActiveFocus()
                                        editField.selectAll()
                                    }
                                    background: Rectangle {
                                        color: parent.highlighted ? "#27272a" : "transparent"
                                        radius: 4
                                    }
                                }

                                MenuItem {
                                    text: "删除"
                                    contentItem: RowLayout {
                                        spacing: 10
                                        Image { source: "img/删除.svg"; sourceSize: Qt.size(14, 14) }
                                        Text { text: "删除记录"; color: "#ef4444"; font.pixelSize: 12 }
                                    }
                                    onTriggered: {
                                        deleteConfirmPopup.open()
                                    }
                                    background: Rectangle {
                                        color: parent.highlighted ? "#27272a" : "transparent"
                                        radius: 4
                                    }
                                }
                            }
                        }
                    }
                }
```

#### 3. 增加删除确认弹窗（放在 `main.qml` 根节点下）

```qml
    // --- 删除确认弹窗 ---
    Popup {
        id: deleteConfirmPopup
        anchors.centerIn: parent
        width: 300
        height: 150
        modal: true
        focus: true
        closePolicy: Popup.CloseOnEscape | Popup.CloseOnPressOutside
        
        background: Rectangle {
            color: "#18181b"
            border.color: "#27272a"
            radius: 12
        }

        ColumnLayout {
            anchors.fill: parent
            anchors.margins: 20
            spacing: 15

            Text {
                text: "确定要删除这段对话吗？"
                color: "white"
                font.pixelSize: 15
                font.weight: Font.Medium
                Layout.alignment: Qt.AlignHCenter
            }

            Text {
                text: "此操作不可撤销。"
                color: "#71717a"
                font.pixelSize: 12
                Layout.alignment: Qt.AlignHCenter
            }

            RowLayout {
                Layout.fillWidth: true
                Layout.topMargin: 10
                spacing: 12
                
                Button {
                    Layout.fillWidth: true
                    text: "取消"
                    onClicked: deleteConfirmPopup.close()
                    // 参考之前的设置界面按钮样式...
                }

                Button {
                    Layout.fillWidth: true
                    text: "删除"
                    onClicked: {
                        // 此处调用真正的删除逻辑
                        conversationManager.delete_conversation(conversationManager.current_conversation_id)
                        deleteConfirmPopup.close()
                    }
                    // 红色警示样式
                    background: Rectangle { color: "#ef4444"; radius: 8 }
                }
            }
        }
    }
```

### 三、 关键细节说明：

1.  **行内编辑 (Inline Edit)**：使用了 `TextField` 直接覆盖在标题文本上。当用户点击重命名时，切换 `isEditing` 属性，输入框自动获得焦点并全选文字，按 `Enter` 保存，按 `Esc` 退出。
2.  **视觉避让**：在 `RowLayout` 中，标题文本设置了 `Layout.fillWidth: true`，而“更多”按钮只有在悬浮时才会出现，这样不会在平时占用标题的空间。
3.  **菜单层级**：`Menu` 和 `Popup` 会自动处理层级问题，确保它们悬浮在所有视图（聊天、设置、更新）之上。
4.  **图标路径**：请确保你的 `img/` 目录下有 `更多.svg`、`重命名.svg` 和 `删除.svg`。如果没有“更多”图标，可以临时用 `text: "..."` 代替图标显示。